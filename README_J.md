# suji command - バージョン文字列ジェネレーター

## はじめに

sujico (suji command・すじこ)はバージョン情報文字列ジェネレーターです。
`sujico` は設定ファイルに記述した数字や文字列，GitやMercurialのコミット情報から文字列を組立てます。
また，オプションを指定することで設定ファイルの値を操作することもできます。

例えば，ビルド時にバージョン文字列を自動生成することができます。

## 使い方

### 簡単な使い方の例

設定ファイルに記述した値と書式で標準出力に出力する例です。

1. テキストエディターなど以下の内容のテキスト入力します:

    ```toml
    Major = 1
    Minor = 0
    format = '''${Major}.${02:Minor}'''
    ```

1. 入力したテキストを `.sujiconf.toml` として保存します
1. `suji` を実行します。以下のような出力をします:

    ```plain
    1.00
    ```

### C言語のプロジェクトに組込む例

設定ファイルにC言語のコードを記述して，実際にCコンパイラでコンパイルをして実行をする例です。

1. テキストエディターなどに以下の内容を入力します

    ```toml
    Major = 1
    Minor = 0
    format = '''#define VERSION "${Major}.${02:Minor}"'''
    ```

1. 入力したテキストを `.sujiconf.toml` として保存します
1. `version.h` としてリダイレクトするように指定して `suji` を実行します
1. テキストエディターなどに以下の内容を入力します:

    ```c
    #include <stdio.h>
    #include "version.h"

    int main(int argc, char* argv[])
    {
      printf("%s\n", VERSION);
      return 0;
    }
    ```

1. 入力したテキストを `test.c` などとして保存してコンパイルすると，バージョン情報を出力します

### ビルド番号の例

ビルド番号などバージョンの値をインクリメントする例です。

1. テキストエディターなどに以下の内容を入力します:

    ```toml
    Major = 1
    Minor = 0
    Build = 100
    format = '''#define VERSION "${Major}.${02:Minor}.${Build}"'''
    ```

1. 入力したテキストを `.sujiconf.toml` として保存します
1. `suji` を実行します。以下のような出力をします:

    ```c
    #define VERSION "1.00.100"
    ```

1. `version.h` としてリダイレクトするように指定して，再度 `suji` を実行します
1. テキストエディターなどに以下の内容を入力します:

    ```c
    # include <stdio.h>
    # include "version.h"

    int main(int argc, char* argv[])
    {
      printf("%s\n", VERSION);
      return 0;
    }
    ```

1. 入力したテキストを `test.c` などとして保存します。コンパイルして実行すると，バージョン情報を出力します
1. `suji` を実行して `.sujiconf.toml` の値をインクリメントします:

    * このとき，`.sujiconf.toml` の内容が書き換わります

    ```sh
    suji -i Build -w > version.h
    ```

1. 先ほどの `test.c` を再コンパイルして実行すると，バージョン情報を出力します。ビルド番号が1増えています

    ```plain
    1.00.101
    ```

## 対応状況

### 凡例

* [ ] ... 未対応 (バージョンアップで対応予定)
* [x] ... 対応済み

### 環境情報

* [ ] OSバージョン
* [ ] コンパイラバージョン
* [ ] ビルド日時
* [ ] ログインユーザー名
* [ ] ビルドパス

### CVS

#### Git

* [x] ハッシュ値
* [x] コミットユーザー（Author）
* [x] コミットユーザーのメールアドレス
* [x] コミット日時
* [ ] タグ
* [ ] ブランチ
* [ ] リモートアドレス

#### Mercurial

* [x] チェンジセット
* [x] ハッシュ値
* [x] タグ
* [x] コミットユーザー
* [x] コミットユーザーのメールアドレス
* [x] コミット日時
* [ ] リモートアドレス

### 演算

* [x] 代入
* [x] インクリメント
  * [x] 整数値
  * [x] 文字
  * [ ] 文字列
* [ ] 四則演算
* [x] 文字列フォーマット

## 設定リファレンス

### 基本書式

* 設定ファイルの書式は [TOML v0.5.0 (github)](https://github.com/toml-lang/toml/blob/master/README.md) に従います
* バージョン情報文字列として用いる値の代入式を記述します
  * 例: `Major = 1`
* `format` キーは特別で，この値を書式として扱います。`format` キーについては以下の「formatキー」セクションを参照ください

### formatキー

* `format` キーの値には変数を用いることができます。変数名は設定ファイルに記述したキー名です。変数を用いるときは `${変数名}` というようにドルマークと波括弧で囲みます
  * 例: `format = '''${Major}'''`
* 文字列を含むこともできます
  * 例: `format = '''Version: ${Major}'''`
* 変数名の指定時に書式を指定することができます。詳細は以下の「値の書式と内部変数」セクションを参照ください

### 値の書式と内部変数

変数名と値の書式の設定値をコロンで区切ることで，値の書式を設定できます。有効な設定値は以下の通りです。

|カテゴリ|設定値|動作|備考|
|---|---|---|---|
|書式|`0M (N: 桁数)`|ゼロ埋め|Integerのみ|
|CVS|git|内部変数のGitの情報を参照|詳細は「CVS>Git」セクションを参照|
||hg|内部変数のMercurialの情報を参照|詳細は「CVS>Mercurial」セクションを参照|

### CVS

実行位置がCVSの管理下である場合，コミットの情報を取得して出力できます。 `sujico` はコミット情報を解析して，内部で保持します。

#### Git

|変数名|内容|備考|
|---|---|---|
|`longhash`|最新コミットの長いハッシュ値||
|`hash`|最新コミットの短いハッシュ値|7文字|
|`tag`|最新コミットのタグ||
|`user`|最新コミットのコミットユーザー||
|`date`|最新コミットのコミット年月日||
|`time`|最新コミットのコミット時間||
|`utcdate`|UTC換算の最新コミットのコミット年月日||
|`utctime`|UTC換算の最新コミットのコミット時間||

### Mercurial

|変数名|内容|備考|
|---|---|---|
|`changeset`|最新コミットのチェンジセット||
|`hash`|最新コミットのハッシュ値|12文字|
|`tag`|最新コミットのタグ||
|`user`|最新コミットのコミットユーザー||
|`date`|最新コミットのコミット年月日||
|`time`|最新コミットのコミット時間||
|`utcdate`|UTC換算の最新コミットのコミット年月日||
|`utctime`|UTC換算の最新コミットのコミット時間||

## コマンドライン・オプション

### -i

指定したキーの値をインクリメントします。

* 非省略形
  * `--increment`
* 対応型
  * Integer
* 指定例
  * `-i Major`
* 実行結果
  * 設定ファイルに記述した `Major` キーの値を+1します
    * たとえば， `Major` キーの値が `1` であれば `2` を出力します
* 失敗
  * 型がIntegerかつ値が `18446744073709551615` (2^64^ - 1)以上のとき，この動作は失敗します

### -s

指定したキーの値を設定します。

* 非省略形
  * `--set`
* 対応型
  * Integer, String
* 指定例
  * `-s Major=1`
* 実行結果
  * 設定ファイルに記述した `Major` キーの値を `1` に更新します
* 失敗
  * 設定ファイルに記述したキーの型がIntegerのとき，String値を代入するような動作は失敗します

### -f

指定したファイルを設定ファイルとして読込みます。

* 非省略形
  * `--file`
* デフォルト値
  * `.sujiconf.toml`
* 指定例
  * `-f conf/myconf.toml`
* 実行結果
  * `conf/myconf.toml` を `.sujiconf.toml` の代わりに読込みます
* 失敗
  * 指定したファイルが存在しない，アクセスできない場合，動作は失敗します

### -w

指定したファイルまたは `-f` で指定したファイルに現在の内容を保存します。

* 非省略形
  * `--write`
* デフォルト値
  * `-f` で指定した値（`-f` の指定が無い場合は `-f` のデフォルト値）
* 指定例
    1. `-w`
    1. `-w newconf.toml`
    1. `-f conf/myconf.toml -w`
* 実行結果
    1. `.sujiconf.toml` に内容を保存します。
    1. `newconf.toml` に内容を保存します。
    1. `conf/myconf.toml` に内容保存します。
* 失敗
  * 指定したファイルに書き込めない場合，動作は失敗します
* 備考
  * 書込んだファイルは，元の記述順を維持しません

### -h

ヘルプを表示します。

* 非省略形
  * `--help`

### -l

使用ライブラリーのライセンス情報を表示します。自分自身のライセンス情報は表示しません。

* 非省略形
  * `--license`

### -v

バージョン情報を表示します。

* 非省略形
  * `--version`

### --verbose

デバッグ情報を表示します。

[!CAUTION]
このオプションを有効にした出力をコンパイルまたは実行しないでください。

### --VERBOSE

デバッグ情報を細かく表示します。

[!CAUTION]
このオプションを有効にした出力をコンパイルまたは実行しないでください。

## `sujico` のビルド

## 必要なソフトウェア

* Boost 1.70.0以上
  * program_options
  * date_time
  * regex
* toml11
* C++ 17 対応のC++コンパイラー
  * g++ 8
  * Visual C++ 2019

## ライセンス

MIT
